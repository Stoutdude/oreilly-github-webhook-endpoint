<!DOCTYPE html><html lang="en"><head><title>bin/issue-to-pr</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="bin/issue-to-pr"><meta name="groc-project-path" content="bin/issue-to-pr.js"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">bin/issue-to-pr.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="issue-to-pr-cli-tool">Issue-to-PR CLI tool</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode">Strict mode</a> is always a good idea.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>eslint-disable no-process-exit </p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'colors'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="modules-we-need-in-this-file">Modules we need in this file</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> GitHub = <span class="hljs-built_in">require</span>(<span class="hljs-string">'github'</span>)
<span class="hljs-keyword">var</span> minimist = <span class="hljs-built_in">require</span>(<span class="hljs-string">'minimist'</span>)
<span class="hljs-keyword">var</span> open = <span class="hljs-built_in">require</span>(<span class="hljs-string">'opn'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="cli-massaging">CLI massaging</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Parse the command-line using <a href="https://www.npmjs.com/package/minimist">minimist</a>.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> argv = minimist(process.argv.slice(<span class="hljs-number">2</span>), {
  string: [<span class="hljs-string">'in'</span>, <span class="hljs-string">'using'</span>, <span class="hljs-string">'token'</span>],
  number: <span class="hljs-string">'issue'</span>
})</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>No args or help (<code>-h</code>/<code>--help</code>)?  Display usage.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">if</span> (process.argv.length === <span class="hljs-number">2</span> || argv.h || argv.help) {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Usage: issue-to-pr [--token=&lt;token&gt;] --in [user/]repo --issue &lt;issue-number&gt; --using [user:]branch'</span>)
  process.exit()
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Check for missing params</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> missingParams = <span class="hljs-literal">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Try and get the token from the CLI, fallback to the environment, default to empty.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> token = <span class="hljs-built_in">String</span>(argv.token || process.env.TOKEN || <span class="hljs-string">''</span>).trim()</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>No token found?  Can&#39;t proceed!</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">if</span> (!token) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Missing token.  Use a TOKEN environment variable or --token=&lt;token&gt; option.'</span>.red)
  missingParams = <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">if</span> (!argv.in) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Missing target repo (where the PR should spawn).  Use --in [user/]repo.'</span>.red)
  missingParams = <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">if</span> (!(argv.issue &gt; <span class="hljs-number">0</span>)) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Missing/invalid issue to turn into a PR.  Use --issue &lt;issue-number&gt;.'</span>.red)
  missingParams = <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">if</span> (!argv.using) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Missing branch to use for the PR.  Use --using [user:]branch..'</span>.red)
  missingParams = <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">if</span> (missingParams) {
  process.exit()
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="api-client-setup">API client setup</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> github = <span class="hljs-keyword">new</span> GitHub({
  version: <span class="hljs-string">'3.0.0'</span>,
  headers: { <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'OReilly-GitHub-Training-Gister/1.0'</span> },
  timeout: <span class="hljs-number">20000</span>
})

github.authenticate({
  type: <span class="hljs-string">'oauth'</span>,
  token: token
})</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If we used a non-qualified repo name as target, we need
the current user&#39;s username to qualify the repo properly
for the API call (owner + name).</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> NWO = <span class="hljs-regexp">/^([\w-]+)\/([\w-]+)$/</span>

<span class="hljs-keyword">if</span> (NWO.test(argv.in)) {
  createPR(argv.in, argv.issue, argv.using)
} <span class="hljs-keyword">else</span> {
  github.user.get({}, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>) </span>{
    <span class="hljs-keyword">if</span> (err || result.error) {
      <span class="hljs-built_in">console</span>.error(err || result.error_description)
      process.exit()
    }

    createPR(result.login + <span class="hljs-string">'/'</span> + argv.in, argv.issue, argv.using)
  })
}</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="actual-api-calls">Actual API calls</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createPR</span> (<span class="hljs-params">nwo, issueNumber, head</span>) </span>{
  nwo = nwo.split(<span class="hljs-string">'/'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>See <a href="https://developer.github.com/v3/pulls/#create-a-pull-request">the API doc page</a>
for details.</p></div></div><div class="code"><div class="wrapper">  github.pullRequests.createFromIssue({
    user: nwo[<span class="hljs-number">0</span>],
    repo: nwo[<span class="hljs-number">1</span>],
    head: head,
    base: <span class="hljs-string">'master'</span>,
    issue: issueNumber
  }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, result</span>) </span>{
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-built_in">String</span>(err).red)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Opening your fresh PR at'</span>.green, result.html_url.cyan)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>As a nice bonus, automatically open the URL with the user&#39;s
preferred software/browser.</p></div></div><div class="code"><div class="wrapper">      open(result.html_url, { wait: <span class="hljs-literal">false</span> })
    }
  })
}</div></div></div></div></body></html>