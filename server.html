<!DOCTYPE html><html lang="en"><head><title>server</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="server"><meta name="groc-project-path" content="server.js"><meta name="groc-github-url" content="https://github.com/deliciousinsights/oreilly-github-webhook-endpoint"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/deliciousinsights/oreilly-github-webhook-endpoint/blob/master/server.js">server.js</a></div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="server-entry-point">Server Entry Point</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Strict_mode">Strict mode</a> is always a good idea.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-pi">'use strict'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A number of our own modules rely on <code>String</code> extensions by the <code>colors</code> module,
so we make sure it&#39;s loaded as early as possible.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-built_in">require</span>(<span class="hljs-string">'colors'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="modules-we-need-in-this-file">Modules we need in this file</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This loads both third-party (from <a href="http://npmjs.com/">npm</a>) and local stuff (paths starting with <code>./</code>).</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'body-parser'</span>)
<span class="hljs-keyword">var</span> cookieSession = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cookie-session'</span>)
<span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">var</span> flash = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-flash'</span>)
<span class="hljs-keyword">var</span> getPort = <span class="hljs-built_in">require</span>(<span class="hljs-string">'getport'</span>)
<span class="hljs-keyword">var</span> gitHubBridge = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./lib/github-bridge'</span>)
<span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>)
<span class="hljs-keyword">var</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">'morgan'</span>)
<span class="hljs-keyword">var</span> userAccount = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./controllers/user-account'</span>)
<span class="hljs-keyword">var</span> webHook = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./controllers/webhook'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="app-amp-server-setup">App &amp; Server Setup</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The port we&#39;d prefer to run on.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> DEFAULT_PORT = <span class="hljs-number">45678</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Initialize a web server app skeleton and wrap an HTTP server around it</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> app = express()
<span class="hljs-keyword">var</span> server = http.createServer(app)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Make the view rendering engine explicit (<a href="http://jade-lang.com/">Jade</a>)</p></div></div><div class="code"><div class="wrapper">app.set(<span class="hljs-string">'view engine'</span>, <span class="hljs-string">'jade'</span>)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="middleware-configuration">Middleware configuration</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Properly interpret fields in incoming web forms.</p></div></div><div class="code"><div class="wrapper">app.use(bodyParser.urlencoded({ extended: <span class="hljs-literal">true</span> }))</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Log incoming requests on the console, in a terse format.</p></div></div><div class="code"><div class="wrapper">app.use(morgan(<span class="hljs-string">'dev'</span>))</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Maintain sessions for clients across HTTP requests, storing
session data in their cookies, with a tamper-proof signature.</p></div></div><div class="code"><div class="wrapper">app.use(cookieSession({ secret: <span class="hljs-string">'GitHub’s API rulez!'</span> }))</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Provide flash-message functionality (messages that persist across
a <a href="https://en.wikipedia.org/wiki/Post/Redirect/Get">Post-Redirect-Get</a> flow).</p></div></div><div class="code"><div class="wrapper">app.use(flash())</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Custom middleware to expose the flash messages to all views, by
making them available in <code>res.locals</code> on every request/response.</p></div></div><div class="code"><div class="wrapper">app.use(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">req, res, next</span>) </span>{
  res.locals.flash = req.flash()
  next()
})</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Register business routes for every part of the app.</p></div></div><div class="code"><div class="wrapper">app.use(webHook.router)
app.use(userAccount.router)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="server-launch">Server Launch</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We request an available local port to listen onto, starting
with our preferred one, <code>DEFAULT_PORT</code>.  But we may get something
higher if that port is already in use.</p></div></div><div class="code"><div class="wrapper">getPort(DEFAULT_PORT, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, port</span>) </span>{</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An error still?  OK, let&#39;s bail out.</p></div></div><div class="code"><div class="wrapper">  <span class="hljs-keyword">if</span> (err) {
    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Could not start server:'</span>, err)
    process.exit()
  }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>OK, so let&#39;s listen on whatever available port we got then…</p></div></div><div class="code"><div class="wrapper">  server.listen(port, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> rootURL = <span class="hljs-string">'http://localhost:'</span> + server.address().port</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>…and display it, just FYI.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Demo service listening on'</span>.green, (rootURL + <span class="hljs-string">'/'</span>).cyan)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Also, if it&#39;s not our preferred port, we might need to re-register
the hook, so let&#39;s say so, in case our user does read the console output
;-)</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">if</span> (DEFAULT_PORT !== port) {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'/!\\ Beware! This is not the intended port (%d): update your app registration.'</span>.red, DEFAULT_PORT)
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Final-phase configuration for the GitHub API bridge and the WebHook
controller (they need to know our root URL to properly setup various
stuff of their own).</p></div></div><div class="code"><div class="wrapper">    gitHubBridge.configure({ rootURL: rootURL })
    webHook.configure({ rootURL: rootURL })</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Our users might have no clue that Ctrl+C is the normal way to stop
a running process, so let&#39;s tell them. :-D</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'\nJust hit Ctrl+C to stop this server.\n'</span>.gray)
  })
})</div></div></div></div></body></html>